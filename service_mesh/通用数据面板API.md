正如我以前所说的，在短短时间内，envoy变得如此成功。 我经常问自己：envoy的哪些方面导致了如我们所见的惊人的社区增长？ 虽然envoy有很多引人注目的特征，但最终我认为主要有三点：

1.性能：随着大量的功能，Envoy提供非常高的吞吐量和低延迟差异，而消耗相对较少的CPU和内存。
2.可扩展性：Envoy在L4和L7都提供了丰富的可插拔过滤功能，使用户可以轻松添加OSS体系中不存在的功能。
3.API可配置性：也许最重要的是，Envoy提供了一套可以通过控制面服务实现的管理API。 如果控制面板实现所有的API，则可以使用通用的引导程序配置在整个基础架构上运行Envoy。 所有进一步的配置更改通过管理服务器以无缝方式动态提供，这使得Envoy永不需要重新启动。 这使得Envoy当与一个复杂的控制面板相结合，成为一个通用的数据面板，大大降低了整体操作的复杂性。

当代代理有的具有超高性能。 也有些具有高度的可扩展性和动态可配置性的。 性能，可扩展性和动态可配置性的结合在我看来使得envoy对于许多人来说如此引人注目。

在这篇文章中，我将概述Envoy动态配置API背后的历史和动机，讨论从v1到v2的演变，最后是鼓励更通用的负载平衡，代理和控制面板社区考虑在其产品中支持这些API。

## V1版API历史

Envoy最初的设计目标之一是利用最终一致的服务发现系统。 为此，我们开发了一个非常简单的发现服务和一个服务发现服务（SDS）REST API，该API返回上游集群成员资格。 该API克服了基于DNS的服务发现（记录限制，缺少额外元数据等）的一些限制，并使我们能够快速实现高可靠性。

当Envoy最初是开源的时候，我们收到了很多关于支持Consul，Kubernetes，Marathon，DNS SRV等其他服务发现系统的询问。我担心我们缺乏对这些系统的直接支持会限制用户的使用。 代码编写得添加新的发现适配器并不难，我希望有关方面能够实现新的发现适配器。 但过去一年实际发生了什么？ 没有一个新的适配器被贡献给代码，但我们已经看到令人难以置信的应用。 这是为什么呢？

在过去的一年中，Envoy增加了多个v1版本的REST管理API，包括：

集群发现服务（CDS）：使用此API，Envoy可以动态地添加/更新/删除所有上游集群（每个集群本身都有自己的服务/终端发现）。
路由发现服务（RDS）：使用此API，Envoy可以动态地添加/更新HTTP路由表。
监听器发现服务（LDS）：使用此API，Envoy可以动态地添加/更新/删除整个监听器，包括其完整的L4和L7过滤器栈。
当控制平面实现SDS / CDS / RDS / LDS时，Envoy的几乎所有方面都可以在运行时进行动态配置。 Istio和Nelson都是在V1 API之上构建的功能非常丰富的控制平面的案例。通过使用相对简单的REST API，Envoy可以快速迭代性能和数据面板功能，同时仍支持各种不同的控制面板方案。此时，通用数据面板的理念正在接近现实。

## v1版API的缺点和v2的介绍

v1版API只有JSON/REST，并且本质上是轮询的。 这有几个缺点：

虽然Envoy在内部使用JSON规格，但是API本身不是强类型的，安全地编写实现它们的通用服务器是很困难的。
虽然在实践中轮询工作正常，但更有能力的控制面板会更喜欢流媒体API，在他们准备就绪时可以将更新推送给每个envoy。 这可能会使更新传播时间从30-60s降低到250-500ms，即使在极其庞大的部署中也是如此。

虽然在实践中轮询工作得不错，但更有能力的控制面板会更喜欢流媒体API，在他们准备就绪时可以将更新推送给每个envoy。 即使在极其庞大的部署中也是如此，这可能会使更新传播时间从30-60s降低到250-500ms。

在与Google的紧密合作中，在过去的几个月里我们一直在努力研究一个称之为v2的新API。 v2版的API具有以下属性：

1. 新的API的规格使用proto3指定，并被gRPC和REST + JSON / YAML的终端实现。另外，它们被定义在一个新的名为envoy-api的专用源代码库中。 proto3的使用意味着API是强类型的，同时通过proto3的JSON / YAML表示仍支持JSON / YAML变体。使用专用库意味着项目将大大简化API的使用，及便于gRPC所支持的所有语言的生成（实际上我们将继续支持基于REST的JSON / YAML变体的用户） 。

2. v2版API不是一场革命，而是v1的发展，是v1的功能超集。 v1的用户会发现v2与他们已经使用的非常接近。 实际上，我们一直在Envoy内部实现v2，以便能够继续永久支持v1（尽管其功能集是被最终冻结的）。

3.不透明的元数据已被添加到各种API响应中，允许大量的可扩展性。 例如，可以将HTTP路由中的元数据接入到上游终端，自定义的负载均衡器基于标签的路由来构建寻址。 我们的目标是在默认的OSS发行版上易于插入丰富的功能。 寻找将来编写Envoy扩展的更强大的文档。
对于使用gRPC（而不是JSON / REST）v2的API消费者，双向流式传输允许一些有趣的增强，我将在下面进行更多的讨论。

V2版API的组成：
1. 终端发现服务（EDS）：这是v1版SDS接口的替代品。SDS是一个不幸的名字选择，所以我们在V2版得以修正。此外，gRPC的双向流媒体性质将允许将负载/健康信息报告给管理服务器，它开启了未来全局负载平衡功能的大门。
2. 集群发现服务（CDS）：与v1相比没有实质性的变化。
3. 路径发现服务（RDS）：与v1相比没有实质性的变化。
4. 侦听器发现服务（LDS）：与v1相比的唯一主要变化是我们现在允许侦听器能根据一组路由规则（例如：SNI，源/目的IP匹配等等），来定义多个并发过滤器栈。这是处理像Istio这样的透明数据面板解决方案所需的“原始目标”策略路由的更清晰的方式。
4. 健康发现服务（HDS）：此API将允许Envoy成为分布式健康检查网络的成员。集中式健康检查服务可以使用一个envoy来统一检查终端和报告状态，从而减轻每个envoy都可能需要对其他envoy进行N^2健康检查问题。
5. 聚合发现服务（ADS）：envoy的设计一般是最终一致的。在默认情况下，这意味着每个管理API都同时运行，且不会相互交互。在某些情况下，单个管理服务器处理所有对单个Envoy的更新有好处的（例如，如果更新需要以避免流量下降的方式有序进行）。该API允许通过单个管理服务器的单gRPC双向流对所有其他API进行编组，从而实现确定性序列。
6. 密钥发现服务（KDS）：该API尚未定义，但我们将添加一个专用的API来投递TLS密钥资料。通过专用密钥管理系统将源自LDS / CDS的秘钥投递，将解耦主监听器和集群配置。

总的来说，我们称上述所有的API为xDS。 从JSON / REST迁移到更易使用的、类型佳的proto3 API是非常令人兴奋的，我认为这将进一步增加API自身以及Envoy的吸引力。

## 多代理多控制平面API？
