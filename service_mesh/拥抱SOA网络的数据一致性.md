https://blog.envoyproxy.io/embracing-eventual-consistency-in-soa-networking-32a5ee5d443d

Envoy的基本设计原则之一是最终的一致性，几乎渗透到系统的每个方面，从线程模型到服务和配置发现（参见这里和这里以获得更多信息）。

当强若最终一致性的范式应用于SoA网络时，我注意到在过去的几年中，许多人发现它是违背常规的。 这并不奇怪 - 最终的一致性在理论上是有道理的，但是当实际应用于许多现实世界的问题时则迅速出现混乱。

当代数据库设计就是一个很好的例子，试图平衡最终一致性的性能收益与强一致性对程序员的易用性。 业界已经看到使用趋势从强一致的事务性RDBMS（如MySQL）转向最终一致的NoSQL系统（如DynamoDB），转而回到可扩展的一致性事务性RDBMS（如Spanner）。 关于为什么程序员应该总是选择强一致性，这个帖子是一个很好的阅读这个话题。 （顺便说一句，我认为Cloud Spanner是一个绝对改变游戏规则的技术，但这不是本文的主题。）

在这篇文章中，我将讨论为什么在SoA网络中拥抱最终的一致性是如此重要。 我还将解释一些分布式系统程序员需要重新考虑如何评估和使用最终一致的服务发现和负载平衡系统以获取全部价值的方式。

## 为什么最终一致性

从根本上说，分布式系统的核心是最终一致的：
计算节点随时可能死亡或暂时失去连接。
网络路径可能会死亡或暂时中断，导致路由更改并可能c出现脑裂的情况。
无论是由于滚动部署，金丝雀，cron抖动还是许多其他因素，软件部署都不会同时发生。
自动缩放通过设计来频繁更改系统拓扑。 节点不会同时关闭，也不会同时启动。 随着行业越来越趋向FaaS，这个事实只会变得更加明显。

另请参阅Werner Vogels撰写的关于深入讨论计算机科学的最终一致性的文章。

当然，可以在最终一致的基础之上对强一致性进行分层; Spanner是一个工程奇迹，就是这样做的。 然而，领导选举，法定人数，共识算法等在工程和运营复杂性方面都有成本，更重要的是增加了延迟。 强一致性保证不是免费的。 对Spanner的读写操作时长可能比应用于最终一致的NoSQL系统要多一个数量级。

回到Envoy和基于SoA的网络和配置发现，对于在数万，数十万甚至数百万个节点中的每一个节点有可能具有整系统的一致的视图吗？ 我不会争辩。 然而，历史上，许多分布式网络系统依靠强一致存储（例如，ZooKeeper）来保存成员资格和软件版本数据。 将这些存储扩展到大数据量是困难的并且会经常导致停机。 那为什么要麻烦？

当最初设计Envoy时，我的目标是拥抱核心分布式网络的最终一致性，并将其推向其逻辑极端：

如果成员数据不一致，为什么我们不能在每个发现服务节点的内存中缓存数十秒？
如果在每个发现服务节点中成员数据被缓存了几十秒，为什么每个envoy都不能缓存几十秒呢？
如果每个envoy缓存数据达数十秒，为什么每个工作线程中都需要envoy的一致性？ （有关这方面的更多信息，请参阅Envoy的线程模型的文章。）

答案是，当涉及分布式网络的成员资格和配置时，不需要在任何地方保持一致性，因为在任何地方都不可能有一致性。 拥抱最终的一致性到处都会产生一个更简单的系统，性能更高，更容易操作。
